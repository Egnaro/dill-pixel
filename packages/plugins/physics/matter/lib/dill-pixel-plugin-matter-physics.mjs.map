{"version":3,"file":"dill-pixel-plugin-matter-physics.mjs","sources":["../src/System.ts","../src/MatterPhysicsPlugin.ts","../src/constants.ts","../src/Entity.ts"],"sourcesContent":["import { Bodies, Body, Engine, Runner, World } from \"matter-js\";\nimport { Graphics, Rectangle } from \"pixi.js\";\n\nimport { IMatterPhysicsObject } from \"./interfaces\";\nimport { MatterBodyLike } from \"./types\";\nimport { MatterPhysicsPluginOptions } from \"./MatterPhysicsPlugin\";\n\nexport class System {\n    public static pluginOptions: Partial<MatterPhysicsPluginOptions>;\n\n    private static _options: Partial<MatterPhysicsPluginOptions>;\n    private static _debug: boolean = false;\n    private static _enabled: boolean = false;\n    private static _runner: Runner;\n    private static _engine: Engine;\n    private static _bounds: Rectangle;\n    private static _objects: Set<IMatterPhysicsObject> = new Set();\n\n    private static _debugGraphics: Graphics;\n\n    static set enabled(value: boolean) {\n        System._enabled = value;\n        if (System._enabled) {\n            if (System._engine) {\n                Runner.run(System._engine);\n            }\n        } else {\n            if (System._runner) {\n                Runner.stop(System._runner);\n            }\n        }\n    }\n\n    static get enabled() {\n        return System._enabled;\n    }\n\n    static set debug(value: boolean) {\n        System._debug = value;\n    }\n\n    static get debug() {\n        return System._debug;\n    }\n\n    static get engine() {\n        return System._engine;\n    }\n\n    static get runner() {\n        return System._runner;\n    }\n\n    static get bounds() {\n        return System._bounds;\n    }\n\n    static set bounds(bounds: Rectangle) {\n        System._bounds = bounds;\n    }\n\n    static initialize(options: Partial<MatterPhysicsPluginOptions>) {\n        System._options = { ...System.pluginOptions, ...options }\n        System._engine = Engine.create(System._options.engine);\n        System._runner = Runner.create(System._options.runner);\n        Runner.run(System._engine);\n\n        if (System._options.worldBounds) {\n            System.bounds = System._options.worldBounds;\n        }\n        if (System._options.createWalls) {\n            const thickness = System._options.createWalls.thickness ?? 10\n            const { width, height } = System.bounds;\n            const walls = []\n            if (System._options.createWalls.top) {\n                walls.push(\n                    Bodies.rectangle(width / 2, - thickness / 2, width, thickness, {\n                        isStatic: true,\n                    })\n                )\n            }\n            if (System._options.createWalls.bottom) {\n                walls.push(Bodies.rectangle(width / 2, height + thickness / 2, width, thickness, {\n                    isStatic: true,\n                }))\n            }\n            if (System._options.createWalls.left) {\n                walls.push(\n                    Bodies.rectangle(-width / 2 - thickness / 2, -thickness / 2, thickness, height + thickness, {\n                        isStatic: true,\n                    })\n                )\n            }\n            if (System._options.createWalls.right) {\n                walls.push(Bodies.rectangle(width / 2 + thickness / 2, -thickness / 2, thickness, height + thickness, {\n                    isStatic: true,\n                }))\n            }\n\n            System.addToWorld(...walls);\n        }\n\n    }\n\n    static addToWorld(...objects: (IMatterPhysicsObject | MatterBodyLike)[]) {\n        objects.forEach((obj) => {\n            let body: MatterBodyLike;\n            // eslint-disable-next-line no-prototype-builtins\n            if (obj.hasOwnProperty('body')) {\n                body = (obj as IMatterPhysicsObject).body;\n                this._objects.add(obj as IMatterPhysicsObject)\n            } else {\n                body = obj as MatterBodyLike;\n            }\n            World.add(System._engine.world, body);\n        });\n    }\n\n    static removeFromWorld(...objects: (IMatterPhysicsObject | MatterBodyLike)[]) {\n        objects.forEach((obj) => {\n            let body: MatterBodyLike;\n            // eslint-disable-next-line no-prototype-builtins\n            if (obj.hasOwnProperty('body')) {\n                body = (obj as IMatterPhysicsObject).body;\n                this._objects.add(obj as IMatterPhysicsObject)\n            } else {\n                body = obj as MatterBodyLike;\n            }\n            World.remove(this._engine.world, body);\n            System._objects.delete(obj as IMatterPhysicsObject);\n        });\n    }\n\n    static update() {\n        if (!System._enabled) {\n            return;\n        }\n        if (System._engine) {\n            System._objects.forEach((obj) => {\n                obj.update();\n            });\n            if (System.debug) {\n                System.drawDebug();\n            }\n            Engine.update(System._engine, 16.666666666666668, 1);\n        }\n    }\n\n    static drawDebug() {\n        if (!System._debugGraphics) {\n            System._debugGraphics = new Graphics();\n            System._debugGraphics.zIndex = 1000;\n            System._debugGraphics.sortableChildren = true;\n        }\n        System._debugGraphics.clear();\n        System._objects.forEach((obj) => {\n            const body = obj.body as Body;\n            const color = obj?.debugColor || 0x29c5f6;\n            const vertices = body.vertices;\n\n            System._debugGraphics.moveTo(vertices[0].x, vertices[0].y);\n\n            for (let j = 1; j < vertices.length; j++) {\n                System._debugGraphics.lineTo(vertices[j].x, vertices[j].y);\n            }\n\n            System._debugGraphics.lineTo(vertices[0].x, vertices[0].y);\n            System._debugGraphics.fill({ color })\n            System._debugGraphics.stroke({ color: 0xff0000, alignment: 0.5 })\n        })\n    }\n}","import { Container, Rectangle } from 'pixi.js';\nimport { IApplication, IPlugin, Plugin } from 'dill-pixel';\nimport { IEngineDefinition, IRunnerOptions } from 'matter-js';\n\nimport { System } from './System';\n\nexport interface IMatterPhysicPlugin extends IPlugin {\n\n}\n\nexport type MatterPhysicsPluginOptions = {\n    debug: boolean;\n    autoInit: boolean;\n    container?: Container;\n    worldBounds?: Rectangle;\n    createWalls?: { thickness: number, top?: boolean, bottom?: boolean, left?: boolean, right?: boolean }\n    engine: Partial<IEngineDefinition>,\n    runner: Partial<IRunnerOptions>,\n}\n\nconst defaultOptions = {\n    debug: false,\n    autoInit: false,\n    engine: {\n    },\n    runner: {\n        delta: 1000 / 60,\n        isFixed: false,\n        enabled: true,\n    }\n}\n\nexport class MatterPhysicsPlugin extends Plugin {\n    private _options: MatterPhysicsPluginOptions;\n    initialize(_app: IApplication, options?: Partial<MatterPhysicsPluginOptions>): void | Promise<void> {\n        this._options = {\n            ...defaultOptions, ...options, runner: { ...defaultOptions.runner, ...options?.runner }, engine: { ...defaultOptions.engine, ...options?.engine }\n        }\n        if (this._options.autoInit) {\n            System.initialize(this._options);\n        }\n    }\n\n    get system(): typeof System {\n        return System;\n    }\n}\n\n\n","export enum PhysicsBodyType {\n    RECTANGLE = 'rectangle',\n    CIRCLE = 'circle',\n    CONVEX = 'convex',\n    TRAPEZOID = 'trapezoid',\n    POLYGON = 'polygon',\n    CHAMFER = 'chamfer',\n}\n","import { Container, Size } from 'dill-pixel';\n\nimport { Bodies } from 'matter-js';\nimport { IMatterPhysicsObject } from './interfaces';\nimport { Container as PIXIContainer } from 'pixi.js';\nimport { PhysicsBodyType } from './constants';\nimport { System } from './System';\n\nexport type EntityConfig = {\n    bodyType?: PhysicsBodyType;\n    size?: Size,\n    view?: PIXIContainer;\n}\n\nexport class Entity extends Container implements IMatterPhysicsObject {\n    public static readonly DEFAULT_DEBUG_COLOR: number = 0x29c5f6;\n    body: Matter.Body;\n    public view: PIXIContainer;\n    public bodyType: PhysicsBodyType;\n\n    constructor(\n        public config: Partial<EntityConfig> = {}\n    ) {\n        super();\n        if (config.view) {\n            this.view = this.add.existing(config.view);\n        }\n        if (config.bodyType) {\n            this.bodyType = config.bodyType\n        }\n    }\n\n    public get debugColor(): number {\n        return Entity.DEFAULT_DEBUG_COLOR;\n    }\n\n    public get system(): typeof System {\n        return System;\n    }\n\n\n    added() {\n        this.createBody();\n        this.system.addToWorld(this);\n    }\n\n    onRemoved(): void {\n        this.system.removeFromWorld(this.body);\n    }\n\n    createBody() {\n        const w = this.config.size?.width || this.view.width;\n        const h = this.config.size?.height || this.view.height;\n\n        switch (this.bodyType) {\n            case PhysicsBodyType.RECTANGLE:\n                this.body = Bodies.rectangle(this.x, this.y, w, h);\n                break;\n            case PhysicsBodyType.CIRCLE:\n                this.body = Bodies.circle(this.x, this.y, w * 0.5);\n                break;\n            case PhysicsBodyType.CONVEX:\n                // this.body = Bodies.fromVertices(this.sprite.x, this.sprite.y, this.sprite.width, this.sprite.height);\n                break;\n            case PhysicsBodyType.TRAPEZOID:\n                this.body = Bodies.trapezoid(this.x, this.y, w, h, 0.5);\n                break;\n        }\n    }\n\n    update() {\n        if (this.view && this.body) {\n            this.x = this.body.position.x;\n            this.y = this.body.position.y;\n            this.rotation = this.body.angle;\n        }\n    }\n}\n"],"names":["_System","value","Runner","bounds","options","Engine","thickness","width","height","walls","Bodies","objects","obj","body","World","Graphics","color","vertices","j","System","defaultOptions","MatterPhysicsPlugin","Plugin","_app","PhysicsBodyType","_Entity","Container","config","w","_a","h","_b","Entity"],"mappings":"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"}